generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

/// AI provider (e.g. Claude, Gemini, Perplexity, GPT, etc.)
model Provider {
  id          String   @id @default(uuid())
  name        String   @unique
  displayName String
  apiBaseUrl  String
  apiType     String   // "openai" | "anthropic" | "google" | "custom"
  modelId     String   // default model ID for this provider
  description String?
  isEnabled   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  assignments RoleAssignment[]
}

/// A role/task category (e.g. coding, search, planning, writing)
model Role {
  id          String   @id @default(uuid())
  slug        String   @unique
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  assignments RoleAssignment[]
  taskLogs    TaskLog[]
}

/// Maps a provider to a role within a project
model RoleAssignment {
  id         String   @id @default(uuid())
  projectId  String
  roleId     String
  providerId String
  priority   Int      @default(0)
  config     String?  // JSON string for provider-specific overrides
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  role     Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  provider Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([projectId, roleId, providerId])
  @@index([projectId])
}

/// A project that groups role assignments
model Project {
  id          String   @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

/// AI-generated task (created by Leader AI decomposition)
model Task {
  id          String   @id @default(uuid())
  projectId   String
  sessionId   String   // Groups tasks created in the same request
  role        String   // Role slug (e.g. "coding", "search")
  mode        String   @default("chat") // "chat" | "computer_use" | "function_calling"
  title       String
  description String
  reason      String?  // Why this task is needed
  dependsOn   String?  // JSON array of task indices, e.g. "[0,1]"
  orderIndex  Int      // Order within the session (0-based)
  status      String   @default("pending") // "pending" | "in_progress" | "completed"
  output      String?  // Result after execution
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([projectId])
  @@index([sessionId])
}

/// API key for authenticated access (linked to Clerk users)
model ApiKey {
  id        String   @id @default(uuid())
  key       String   @unique // "ak_xxx" format
  userId    String   // Clerk user ID
  name      String   @default("default") // Human-readable label
  revoked   Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([key])
}

/// Execution log for tasks sent to AI providers
model TaskLog {
  id         String   @id @default(uuid())
  projectId  String
  roleId     String
  providerId String
  input      String
  output     String?
  status     String   // "pending" | "success" | "error"
  errorMsg   String?
  durationMs Int?
  createdAt  DateTime @default(now())

  role Role @relation(fields: [roleId], references: [id])

  @@index([projectId])
}
